---
phase: 01-pipeline-coherence
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/prompts/carousel-prompt.ts
  - src/lib/prompts/index.ts
autonomous: true

must_haves:
  truths:
    - "All carousel slides are generated in a single Claude call"
    - "Claude plans the complete narrative arc before generating slide content"
    - "Generated content includes structured narrative metadata (arc position, emotional beat)"
  artifacts:
    - path: "src/lib/prompts/carousel-prompt.ts"
      provides: "Carousel-specific prompt system for all-at-once generation"
      exports: ["CAROUSEL_SYSTEM_PROMPT", "buildCarouselUserPrompt", "CarouselGenerationResult"]
    - path: "src/lib/prompts/index.ts"
      provides: "Updated barrel export including carousel prompts"
      contains: "export.*carousel-prompt"
  key_links:
    - from: "src/lib/prompts/carousel-prompt.ts"
      to: "src/lib/design/types.ts"
      via: "import DesignContext for type safety"
      pattern: "import.*DesignContext.*from.*design"
---

<objective>
Create a dedicated carousel prompt system that generates ALL slides in a single Claude call with explicit narrative arc planning.

Purpose: Sequential slide generation loses narrative coherence. By generating all slides together, Claude can plan the complete story arc (hook -> buildup -> climax -> CTA) and ensure content flows naturally. This addresses PIPE-01.

Output: A new carousel-specific prompt module that enforces all-at-once generation with narrative structure.
</objective>

<execution_context>
@~/.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/SUMMARY.md

Current content prompt: @src/lib/prompts/content-prompt.ts
Design Context types: @src/lib/design/types.ts (from Plan 01)

Key insight from research:
"All slides generated in ONE AI call. This allows Claude to plan the narrative arc (hook -> buildup -> climax -> CTA) and ensure content flows. Sequential generation loses this coherence."
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Carousel-Specific System Prompt</name>
  <files>src/lib/prompts/carousel-prompt.ts</files>
  <action>
Create a focused prompt system for carousel generation that enforces:
1. Narrative arc planning BEFORE content generation
2. All slides generated together with awareness of each other
3. Design context awareness (but NOT design decisions - those come from DesignContext)

Create the file with:

1. Import DesignContext type from '@/lib/design'

2. Define `CarouselSlideOutput` interface:
   ```typescript
   interface CarouselSlideOutput {
     slideNumber: number;
     text: string;           // The copy for this slide
     visualHint: string;     // Mood/metaphor guidance (10-20 words)
     narrativeRole: 'hook' | 'buildup' | 'climax' | 'resolution' | 'cta';
     emotionalBeat: string;  // e.g., "curiosity", "tension", "revelation", "action"
   }
   ```

3. Define `CarouselGenerationResult` interface:
   ```typescript
   interface CarouselGenerationResult {
     narrativeArc: {
       theme: string;           // The overarching story theme
       tension: string;         // What creates the narrative tension
       resolution: string;      // How the tension resolves
     };
     slides: CarouselSlideOutput[];
     caption: string;           // Instagram caption
     hashtags: string[];
     cta: string;
   }
   ```

4. Create `CAROUSEL_SYSTEM_PROMPT` constant:
   - Start with brief persona (expert content strategist)
   - Emphasize: "You are generating a COMPLETE carousel. All slides must work together as a unified narrative."
   - Explain narrative arc structure:
     * Slide 1 (Hook): Stop the scroll. Create curiosity or tension.
     * Slides 2-N-1 (Buildup): Deliver value, build toward the climax.
     * Slide N-1 (Climax): The key insight or transformation moment.
     * Slide N (CTA): Clear next action, resolution of the narrative.
   - Include explicit instruction: "Before writing ANY slide, first plan the complete narrative arc. What is the tension? How does it build? What is the climax?"
   - Use calm, instructive language (avoid CRITICAL/MUST/NEVER - per Claude 4.5 best practices)
   - Output format: JSON matching CarouselGenerationResult

5. Create `buildCarouselUserPrompt(params)` function:
   Parameters:
   - idea: { concept, angle, keyPoints, potentialHooks }
   - sourceContent: string
   - designContext: DesignContext (for awareness, not decisions)
   - brandVoicePrompt: string
   - slideCount?: number (optional, let AI decide if not specified)

   The prompt should:
   - Present the idea and source material
   - Include the brand voice prompt
   - Mention the visual style from designContext (so AI understands the aesthetic)
   - NOT include specific colors or typography (those are locked by designContext)
   - Request the specified number of slides (or let AI determine optimal count)

6. Export all types and functions.

IMPORTANT: Do NOT include detailed image prompts in this system. Slides generate TEXT and visualHints only. Image generation is handled by the compositor with the locked DesignContext.
  </action>
  <verify>
`npx tsc --noEmit src/lib/prompts/carousel-prompt.ts` compiles without errors.
  </verify>
  <done>
carousel-prompt.ts exists with CAROUSEL_SYSTEM_PROMPT, buildCarouselUserPrompt, and typed interfaces for structured carousel generation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Prompts Barrel Export</name>
  <files>src/lib/prompts/index.ts</files>
  <action>
1. Read the existing src/lib/prompts/index.ts

2. Add exports for the new carousel prompt module:
   ```typescript
   export {
     CAROUSEL_SYSTEM_PROMPT,
     buildCarouselUserPrompt,
     type CarouselSlideOutput,
     type CarouselGenerationResult,
   } from './carousel-prompt';
   ```

3. Ensure no duplicate exports or conflicts with existing content-prompt exports.

4. Keep all existing exports intact.
  </action>
  <verify>
`npm run build` passes without errors.
  </verify>
  <done>
Carousel prompt module is accessible via `import { CAROUSEL_SYSTEM_PROMPT, buildCarouselUserPrompt } from '@/lib/prompts'`.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Narrative Arc Examples to Prompt</name>
  <files>src/lib/prompts/carousel-prompt.ts</files>
  <action>
Enhance the CAROUSEL_SYSTEM_PROMPT with concrete examples (per Claude 4.5 best practices - explicit examples beat abstract guidelines):

1. Add a "Narrative Arc Examples" section to the system prompt with 2-3 complete examples:

Example 1 (Educational/How-To):
```
Theme: "The hidden cost of multitasking"
Tension: "We think we're being productive, but we're actually losing time"
Resolution: "Focus on one thing at a time to reclaim your day"

Slides:
1. [Hook] "You're not busy. You're distracted." (curiosity)
2. [Buildup] "Every time you switch tasks, your brain needs 23 minutes to refocus" (revelation)
3. [Buildup] "That 'quick email check' just cost you an hour" (pain point)
4. [Climax] "Single-tasking isn't slower. It's 40% faster." (transformation)
5. [CTA] "Try it tomorrow: One task. One hour. Zero interruptions." (action)
```

Example 2 (Story-based):
```
Theme: "From burnout to balance"
Tension: "I thought success meant working harder"
Resolution: "I learned that rest is productive"

Slides:
1. [Hook] "I used to brag about sleeping 4 hours a night" (confession)
2. [Buildup] "Then I started forgetting people's names" (consequence)
3. [Buildup] "My doctor said my cortisol was 3x normal" (escalation)
4. [Climax] "I took a month off. My best ideas came in week 3." (transformation)
5. [CTA] "What would happen if you actually rested?" (reflection)
```

2. Add instruction: "Notice how each slide knows what comes before and after it. The hook creates tension that the buildup develops and the climax resolves. This is impossible to achieve when generating slides independently."

3. Emphasize: "Your output will be used to create a cohesive visual carousel. Each slide's text must stand alone visually but connect narratively."
  </action>
  <verify>
Review the prompt - does it clearly demonstrate narrative arc planning? Would a different AI instance understand how to structure the output?
  </verify>
  <done>
CAROUSEL_SYSTEM_PROMPT includes concrete narrative arc examples that demonstrate the expected output structure.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. `npm run lint` passes (or no new errors)
3. New file exists: src/lib/prompts/carousel-prompt.ts
4. Exports work: Can import { CAROUSEL_SYSTEM_PROMPT, buildCarouselUserPrompt } from '@/lib/prompts'
5. CarouselGenerationResult type includes narrativeArc with theme/tension/resolution
6. System prompt includes concrete examples of narrative arcs
</verification>

<success_criteria>
- Carousel prompt module exists with all-at-once generation approach
- Prompt explicitly requires narrative arc planning BEFORE slide content
- Each slide has narrativeRole (hook/buildup/climax/cta) and emotionalBeat
- Concrete examples demonstrate expected output structure
- Design context is referenced for awareness but not for decisions
</success_criteria>

<output>
After completion, create `.planning/phases/01-pipeline-coherence/01-02-SUMMARY.md`
</output>
