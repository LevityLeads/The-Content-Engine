---
phase: 01-pipeline-coherence
plan: 05
type: execute
wave: 4
depends_on: ["01-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Generated carousel has visually consistent slides (same colors, typography, layout)"
    - "Narrative arc flows naturally from hook through buildup to CTA"
    - "Design context values are identical across all slides (verified via logs)"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete pipeline coherence by generating test carousels and confirming visual/narrative consistency.

Purpose: This plan validates that all Phase 1 requirements (PIPE-01, PIPE-02, PIPE-03) are satisfied through end-to-end testing.

Output: Verified coherent carousel generation with documented evidence.
</objective>

<execution_context>
@~/.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Phase 1 Success Criteria (from ROADMAP.md):
1. User can generate a complete carousel where all slides share consistent visual style (colors, typography, layout)
2. User can see that narrative arc flows naturally from hook through buildup to CTA across slides
3. User cannot generate slides that violate template layout constraints (AI handles content, templates handle design)
4. User observes same design context applied to all slides without drift or reinterpretation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Test Idea for Carousel Generation</name>
  <files></files>
  <action>
Use the Supabase client to create a test idea for carousel generation:

1. First, check for an existing brand or create one if needed:
   ```bash
   # Check existing brands
   curl -s "$NEXT_PUBLIC_SUPABASE_URL/rest/v1/brands?select=id,name" \
     -H "apikey: $NEXT_PUBLIC_SUPABASE_ANON_KEY" | head -1
   ```

2. Create a test input (if no existing one):
   ```bash
   curl -X POST "$NEXT_PUBLIC_SUPABASE_URL/rest/v1/inputs" \
     -H "apikey: $NEXT_PUBLIC_SUPABASE_ANON_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "brand_id": "[BRAND_ID]",
       "raw_content": "Research shows that taking regular breaks increases productivity by 40%. The Pomodoro technique suggests 25-minute work sessions followed by 5-minute breaks. After 4 sessions, take a longer 15-30 minute break. This aligns with our natural attention span and helps prevent burnout.",
       "type": "text",
       "status": "pending"
     }'
   ```

3. Create a test idea:
   ```bash
   curl -X POST "$NEXT_PUBLIC_SUPABASE_URL/rest/v1/ideas" \
     -H "apikey: $NEXT_PUBLIC_SUPABASE_ANON_KEY" \
     -H "Content-Type: application/json" \
     -d '{
       "brand_id": "[BRAND_ID]",
       "input_id": "[INPUT_ID]",
       "concept": "The science of productive breaks",
       "angle": "educational",
       "target_platforms": ["instagram"],
       "key_points": [
         "40% productivity increase with regular breaks",
         "Pomodoro technique: 25 min work, 5 min break",
         "Natural attention span alignment"
       ],
       "potential_hooks": [
         "You are not lazy. You are burned out.",
         "What if doing less made you more productive?",
         "The most productive people take MORE breaks"
       ],
       "status": "approved"
     }'
   ```

Record the created idea ID for the next task.
  </action>
  <verify>
Idea exists in database with status 'approved'.
  </verify>
  <done>
Test idea created with realistic content for carousel generation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate Carousel Content via New Endpoint</name>
  <files></files>
  <action>
Call the new carousel content generation endpoint:

```bash
curl -X POST "http://localhost:3000/api/content/carousel" \
  -H "Content-Type: application/json" \
  -d '{
    "ideaId": "[IDEA_ID]",
    "visualStyle": "typography",
    "textStyle": "bold-editorial"
  }'
```

Capture the response and verify:
1. Response includes `success: true`
2. Response includes `designContext` with all fields populated
3. Response includes `narrativeArc` with theme/tension/resolution
4. `content.metadata.designContext` matches the returned designContext
5. `content.copy_carousel_slides` contains slides with narrativeRole and emotionalBeat

Save the contentId and designContext for image generation.
  </action>
  <verify>
Response JSON shows narrativeArc and designContext. Slides have narrativeRole assignments.
  </verify>
  <done>
Carousel content generated with narrative arc and design context.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate Carousel Images with DesignContext</name>
  <files></files>
  <action>
Call the image carousel endpoint with the design context from content generation:

```bash
curl -X POST "http://localhost:3000/api/images/carousel" \
  -H "Content-Type: application/json" \
  -d '{
    "contentId": "[CONTENT_ID]",
    "slides": [
      { "slideNumber": 1, "text": "[SLIDE_1_TEXT]" },
      { "slideNumber": 2, "text": "[SLIDE_2_TEXT]" },
      { "slideNumber": 3, "text": "[SLIDE_3_TEXT]" },
      { "slideNumber": 4, "text": "[SLIDE_4_TEXT]" }
    ],
    "designContext": [DESIGN_CONTEXT_FROM_STEP_2],
    "backgroundStyle": "gradient-dark"
  }'
```

Check server logs for:
1. "[Carousel Images] Design context resolved: source=provided"
2. "[Slide N] Compositing with design:" showing same primaryColor for all slides
3. All slides completing successfully
  </action>
  <verify>
Server logs show consistent design context across all slides. Images generated successfully.
  </verify>
  <done>
Carousel images generated using the same design context as content.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete carousel generation pipeline with:
1. Design Context Provider (computes visual system once)
2. All-at-once carousel content generation (narrative arc planning)
3. Template-first image composition (locked design enforcement)
  </what-built>
  <how-to-verify>
1. Open the content page in the dashboard: http://localhost:3000/content
2. Find the generated carousel content
3. View all carousel slides and verify:
   - All slides have IDENTICAL colors (text color, accent color)
   - All slides have IDENTICAL typography (font size, weight)
   - All slides have IDENTICAL layout (padding, positioning)
   - Narrative flows naturally: hook creates curiosity, middle builds value, CTA provides resolution
4. Check that no slide "looks different" from the others
5. If brand colors were specified, verify they appear consistently

Expected outcome: A cohesive carousel that looks like one designer made all slides.
  </how-to-verify>
  <resume-signal>Type "approved" if carousel is visually consistent, or describe specific inconsistencies observed.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 Success Criteria Checklist:
- [ ] All slides share consistent visual style (colors, typography, layout)
- [ ] Narrative arc flows naturally from hook through buildup to CTA
- [ ] Templates enforce design constraints (AI cannot violate layout)
- [ ] Same design context applied to all slides without drift

PIPE-01: All-at-once generation
- [ ] Carousel content generated in single Claude call
- [ ] Response includes narrativeArc with theme/tension/resolution
- [ ] Each slide has narrativeRole (hook/buildup/climax/cta)

PIPE-02: Design Context Provider
- [ ] Design context computed once from brand config + style
- [ ] Design context passed to image generation
- [ ] Server logs show "source=provided" for image generation

PIPE-03: Template-first enforcement
- [ ] Templates use DesignContext properties directly
- [ ] No design decisions made inside templates
- [ ] All slides use identical visual properties
</verification>

<success_criteria>
- Test carousel generated successfully through complete pipeline
- Visual inspection confirms all slides are consistent
- Server logs confirm design context flows without recomputation
- Human verification approves carousel coherence
</success_criteria>

<output>
After completion and approval, create `.planning/phases/01-pipeline-coherence/01-05-SUMMARY.md` documenting:
- Test results
- Screenshots or descriptions of generated carousel
- Any issues found and how they were resolved
- Confirmation that Phase 1 success criteria are met
</output>
